# éƒ¨ç½²æ“ä½œæŒ‡å—

> ğŸš€ æœ¬æ–‡æ¡£æä¾›äº† Kairos-BE é¡¹ç›®çš„è¯¦ç»†éƒ¨ç½²æ“ä½œæŒ‡å—ï¼ŒåŒ…æ‹¬ç¯å¢ƒé…ç½®ã€éƒ¨ç½²æµç¨‹å’Œæ•…éšœæ’é™¤ã€‚

## å‰ç½®è¦æ±‚

### 1. ç³»ç»Ÿè¦æ±‚

- **Node.js**: ç‰ˆæœ¬ 18 æˆ–æ›´é«˜
- **AWS CLI**: å·²é…ç½®é€‚å½“çš„å‡­è¯
- **SST CLI**: å…¨å±€å®‰è£… `npm install -g sst`

### 2. AWS é…ç½®

ç¡®ä¿ AWS CLI å·²æ­£ç¡®é…ç½®ï¼š

```bash
# é…ç½® AWS å‡­è¯
aws configure

# éªŒè¯é…ç½®
aws sts get-caller-identity
```

## å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹è®¾ç½®

```bash
# å®‰è£…é¡¹ç›®ä¾èµ–
npm install

# æ£€æŸ¥ SST é…ç½®
npx sst check
```

### 2. å¼€å‘ç¯å¢ƒéƒ¨ç½²

```bash
# éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
npx sst deploy --stage dev

# æˆ–ä½¿ç”¨é»˜è®¤é˜¶æ®µ
npx sst deploy
```

### 3. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

```bash
# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
npx sst deploy --stage prod
```

## ç¯å¢ƒç®¡ç†

### é˜¶æ®µé…ç½®

é¡¹ç›®æ”¯æŒå¤šä¸ªéƒ¨ç½²é˜¶æ®µï¼š

- **dev**: å¼€å‘ç¯å¢ƒ
- **staging**: é¢„å‘å¸ƒç¯å¢ƒ
- **prod**: ç”Ÿäº§ç¯å¢ƒ

### ç¯å¢ƒç‰¹å®šèµ„æº

æŸäº›èµ„æºä»…åœ¨ç‰¹å®šç¯å¢ƒä¸­åˆ›å»ºï¼š

```typescript
// ç¤ºä¾‹ï¼šä»…åœ¨ç”Ÿäº§ç¯å¢ƒåˆ›å»ºç›‘æ§èµ„æº
if (process.env.SST_STAGE === "prod") {
  // ç”Ÿäº§ç¯å¢ƒç‰¹å®šèµ„æº
}
```

## èµ„æºç®¡ç†

### æ·»åŠ æ–°èµ„æº

1. **æ•°æ®åº“è¡¨**: ç¼–è¾‘ `deploy/database/dynamodb.ts`
2. **API ç«¯ç‚¹**: ç¼–è¾‘ `deploy/api/rest.ts` æˆ– `deploy/api/graphql.ts`
3. **å®šæ—¶ä»»åŠ¡**: ç¼–è¾‘ `deploy/cron/tasks.ts`
4. **è®¤è¯æœåŠ¡**: ç¼–è¾‘ `deploy/auth/cognito.ts`
5. **å…±äº«é…ç½®**: ç¼–è¾‘ `deploy/shared/linkables.ts`

### æ›´æ–°ç°æœ‰èµ„æº

1. ä¿®æ”¹ `deploy/` ç›®å½•ä¸­çš„ç›¸åº”æ–‡ä»¶
2. è¿è¡Œ `npx sst diff` é¢„è§ˆæ›´æ”¹
3. è¿è¡Œ `npx sst deploy` åº”ç”¨æ›´æ”¹

### åˆ é™¤èµ„æº

1. ä»ç›¸åº”æ–‡ä»¶ä¸­åˆ é™¤èµ„æºå®šä¹‰
2. è¿è¡Œ `npx sst diff` é¢„è§ˆæ›´æ”¹
3. è¿è¡Œ `npx sst deploy` åº”ç”¨æ›´æ”¹

## ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€

```bash
# æ£€æŸ¥å½“å‰éƒ¨ç½²çŠ¶æ€
npx sst state

# æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—
npx sst logs
```

### è°ƒè¯•æ¨¡å¼

```bash
# å¯åŠ¨å¼€å‘æ¨¡å¼ï¼ˆå®æ—¶é‡è½½ï¼‰
npx sst dev

# è®¿é—®å·²éƒ¨ç½²çš„å‡½æ•°
npx sst shell
```

### èµ„æºæ£€æŸ¥

```bash
# åˆ—å‡ºæ‰€æœ‰å·²éƒ¨ç½²çš„èµ„æº
npx sst list

# è·å–èµ„æºè¯¦ç»†ä¿¡æ¯
npx sst info
```

## éƒ¨ç½²æµç¨‹

### 1. å¼€å‘ç¯å¢ƒéƒ¨ç½²

```bash
# 1. æ£€æŸ¥é…ç½®
npx sst check

# 2. é¢„è§ˆæ›´æ”¹
npx sst diff

# 3. éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
npx sst deploy --stage dev

# 4. éªŒè¯éƒ¨ç½²
npx sst list
```

### 2. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

```bash
# 1. ç¡®ä¿å¼€å‘ç¯å¢ƒæµ‹è¯•é€šè¿‡
npx sst deploy --stage dev

# 2. é¢„è§ˆç”Ÿäº§ç¯å¢ƒæ›´æ”¹
npx sst diff --stage prod

# 3. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
npx sst deploy --stage prod

# 4. éªŒè¯ç”Ÿäº§ç¯å¢ƒ
npx sst list --stage prod
```

### 3. å›æ»šéƒ¨ç½²

```bash
# æŸ¥çœ‹éƒ¨ç½²å†å²
npx sst state

# å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬
npx sst deploy --stage prod --previous
```

## æœ€ä½³å®è·µ

### 1. èµ„æºå‘½å

- ä½¿ç”¨æè¿°æ€§çš„èµ„æºåç§°
- åŒ…å«é˜¶æ®µå‰ç¼€ç”¨äºç”Ÿäº§èµ„æº
- éµå¾ªä¸€è‡´çš„å‘½åçº¦å®š

### 2. é…ç½®ç®¡ç†

- å°†æ•æ„Ÿæ•°æ®å­˜å‚¨åœ¨ SST secrets ä¸­
- ä½¿ç”¨ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®
- é¿å…åœ¨éƒ¨ç½²æ–‡ä»¶ä¸­ç¡¬ç¼–ç å€¼

### 3. æµ‹è¯•éªŒè¯

- åœ¨å¼€å‘ç¯å¢ƒä¸­é¦–å…ˆæµ‹è¯•æ›´æ”¹
- ä½¿ç”¨ `npx sst diff` é¢„è§ˆæ›´æ”¹
- åœ¨éƒ¨ç½²å‰éªŒè¯é…ç½®

### 4. å®‰å…¨æ€§

- ä½¿ç”¨æœ€å°æƒé™ IAM ç­–ç•¥
- ä¸ºæ•æ„Ÿæ•°æ®å¯ç”¨åŠ å¯†
- å®šæœŸè½®æ¢è®¿é—®å¯†é’¥

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. å¯¼å…¥é”™è¯¯

**é—®é¢˜**: SST é…ç½®ä¸­çš„é™æ€å¯¼å…¥é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿åœ¨ `sst.config.ts` ä¸­ä½¿ç”¨åŠ¨æ€å¯¼å…¥

```typescript
// æ­£ç¡®çš„æ–¹å¼
async run() {
  const { createInfrastructure } = await import("./deploy");
  // ...
}

// é”™è¯¯çš„æ–¹å¼
import { createInfrastructure } from "./deploy";
```

#### 2. èµ„æºå†²çª

**é—®é¢˜**: é‡å¤çš„èµ„æºåç§°

**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥æ‰€æœ‰æ¨¡å—æ–‡ä»¶ä¸­çš„èµ„æºåç§°ï¼Œç¡®ä¿å”¯ä¸€æ€§

#### 3. æƒé™é”™è¯¯

**é—®é¢˜**: AWS æƒé™ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:

- éªŒè¯ AWS å‡­è¯
- æ£€æŸ¥ IAM æƒé™
- ç¡®ä¿ç”¨æˆ·æœ‰è¶³å¤Ÿçš„æƒé™

#### 4. è¶…æ—¶é—®é¢˜

**é—®é¢˜**: å‡½æ•°æ‰§è¡Œè¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**: è°ƒæ•´å‡½æ•°è¶…æ—¶è®¾ç½®

```typescript
function: {
  handler: "functions/src/functions/api.handler",
  runtime: "python3.11",
  timeout: "5 minutes", // å¢åŠ è¶…æ—¶æ—¶é—´
}
```

### è·å–å¸®åŠ©

- æŸ¥çœ‹ SST æ–‡æ¡£: https://sst.dev
- æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—: `npx sst logs`
- ä½¿ç”¨ SST è¯Šæ–­: `npx sst diagnostic`

## è¿ç§»æŒ‡å—

### ä»å•ä½“åˆ°æ¨¡å—åŒ–

å¦‚æœä»å•ä¸€çš„ `sst.config.ts` æ–‡ä»¶è¿ç§»ï¼š

1. åˆ›å»º `deploy/` ç›®å½•ç»“æ„
2. å°†èµ„æºå®šä¹‰ç§»åŠ¨åˆ°ç›¸åº”çš„æ¨¡å—
3. æ›´æ–° `sst.config.ts` ä½¿ç”¨åŠ¨æ€å¯¼å…¥
4. ä½¿ç”¨ `npx sst diff` æµ‹è¯•éƒ¨ç½²
5. é€æ­¥éƒ¨ç½²æ›´æ”¹

### ç‰ˆæœ¬æ›´æ–°

æ›´æ–° SST ç‰ˆæœ¬æ—¶ï¼š

1. æ£€æŸ¥å‘å¸ƒè¯´æ˜ä¸­çš„ç ´åæ€§æ›´æ”¹
2. æ ¹æ®éœ€è¦æ›´æ–°èµ„æºé…ç½®
3. é¦–å…ˆåœ¨å¼€å‘ç¯å¢ƒä¸­æµ‹è¯•
4. éªŒè¯åéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

## è‡ªåŠ¨åŒ–éƒ¨ç½²

### CI/CD é›†æˆ

å¯ä»¥ä½¿ç”¨ GitHub Actions æˆ–å…¶ä»– CI/CD å·¥å…·è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼š

```yaml
# .github/workflows/deploy.yml
name: Deploy to AWS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: "18"
      - run: npm install
      - run: npx sst deploy --stage prod
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
```

---

**ç›¸å…³æ–‡æ¡£**:

- [éƒ¨ç½²æ¶æ„è®¾è®¡](./deployment-architecture.md) - æ¨¡å—åŒ–éƒ¨ç½²æ¶æ„
- [ç¯å¢ƒé…ç½®](./environment-setup.md) - å¼€å‘ç¯å¢ƒé…ç½®
- [åŸºç¡€è®¾æ–½æ¶æ„](./infrastructure.md) - AWS åŸºç¡€è®¾æ–½è®¾è®¡
